-- SQLite
CREATE TABLE Clients (
    ClientID INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL,
    Email TEXT UNIQUE NOT NULL,
    Phone TEXT UNIQUE,
    DateInscription DATE DEFAULT CURRENT_DATE,
    Statut TEXT DEFAULT 'ACTIF'
);

CREATE TABLE relations (
    idRelation INTEGER PRIMARY KEY AUTOINCREMENT,
    parrainID INTEGER,
    filleulID INTEGER NOT NULL UNIQUE,
    DateRelation DATE DEFAULT CURRENT_DATE,
    CHECK (parrainID IS NULL OR parrainID != filleulID),
    FOREIGN KEY (parrainID) REFERENCES Clients(ClientID),
    FOREIGN KEY (filleulID) REFERENCES Clients(ClientID)
);

CREATE TABLE Achats (
    idAchat INTEGER PRIMARY KEY AUTOINCREMENT,
    ClientID INTEGER NOT NULL,
    DateAchat DATE DEFAULT CURRENT_DATE,
    Montant REAL NOT NULL CHECK (Montant > 0),
    FOREIGN KEY (ClientID) REFERENCES Clients(ClientID)
);

CREATE VIEW ClientsPlusRentable AS 
SELECT Clients.Name, SUM(Achats.Montant) AS TotalAchats
FROM Clients
JOIN Achats on Clients.ClientID = Achats.ClientID
GROUP BY Clients.ClientID
ORDER BY TotalAChats DESC;